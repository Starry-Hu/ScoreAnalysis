<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/font.css">
    <link rel="stylesheet" href="lib/layui/css/layui.css">
    <title>班级学生总况</title>
    <style>
        form {
            width: 300px;
        }
    </style>
</head>

<body class="layui-anim layui-anim-up">
<div>
        <span class="layui-breadcrumb">
            <a href="">首页</a>
            <a>
                <cite>导航元素</cite></a>
        </span>
</div>
<div>
    <div class="demoTable">

        <!--<div class="layui-inline">-->
        <!--<input class="layui-input" name="id" id="demoReload" autocomplete="off">-->
        <!--</div>-->
        <form id="editForm" class="layui-form">
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <label class="layui-form-label must" for="clsId">对应文件</label>
                    <select name="clsId" id="clsId">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="layui-btn" data-type="reload" id="search">班级搜索</div>
        </form>
    </div>


    <table id="students" lay-filter="test"></table>
</div>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-sm" lay-event="inform">通知</a>
</script>

<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
<script src="lib/layui/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="js/layuiRowSpan.js"></script>

<script>
    layui.use(['table', 'form'], function () {
        var table = layui.table;
        var form = layui.form;

        jQuery(function () {
            // 加载可选班级
            jQuery.ajax({
                type: "get",
                url: "/ScoreAnalysis/class/getAllClasses", // 需要带上项目名(只有上传文件的时候不需要)
                dataType: "json",
                async: false,
                success: function (response) {
                    for (let i = 0; i < response.data.length; i++) {
                        const element = response.data[i];
                        var $option = `<option value='${element.clsid}'> ${element.clsName}</option>`;
                        $('#clsId').append($option);
                    }
                    form.render();
                }
            });
        })


        //展示已知数据
        table.render({
            elem: '#students',
            // toolbar: true,
            toolbar: 'default',
            url: 'student/getStuInfoByStuClsWithPage?clsId=021101', //数据接口(不需要带项目名)
            parseData: function (res) { //res 即为原始返回的数据
                var stuInfo = new Array();
                for (let i = 0; i < res.data.list.length; i++) {
                    for (let j = 0; j < res.data.list[i].undoCourse.length; j++) {
                        // 根据长度自己拼接成json字符串
                        var jsonString = `{ "sid": "${res.data.list[i].sid}", "sname": "${res.data.list[i].sname}", "className": "${res.data.list[i].className}",
                        "majorName" : "${res.data.list[i].majorName}", "undoCourseOneCid": "${res.data.list[i].undoCourse[j].cid}",
                        "undoCourseOneCname": "${res.data.list[i].undoCourse[j].cname}", "undoCourseOneCredit": ${res.data.list[i].undoCourse[j].credit},
                        "undoCourseOneScore": ${res.data.list[i].undoCourse[j].score} }`;
                        // 将上述字符串转成json
                        var obj = JSON.parse(jsonString);
                        // 添加到数组中
                        stuInfo.push(obj);
                    }
                }
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data.totalRecord, //解析数据长度
                    // "data": res.data.list, //解析数据列表
                    "data": stuInfo, //解析数据列表
                };
            },
            response: {
                statusCode: 205 //规定成功的状态码，默认：0
            },
            request: {
                pageName: 'pageNum' //页码的参数名称，默认：page
                , limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            cols: [
                [{
                    field: 'sname',
                    title: '姓名',
                    width: 180
                }, {
                    field: 'className',
                    title: '班级',
                    width: 180
                }, {
                    field: 'majorName',
                    title: '专业',
                    width: 180
                }, {
                    field: 'undoCourseOneCid',
                    title: '未修课程号',
                    minWidth: 80
                }, {
                    field: 'undoCourseOneCname',
                    title: '课程名称',
                    minWidth: 80
                }, {
                    field: 'undoCourseOneCredit',
                    title: '课程学分',
                    width: 100
                }, {
                    field: 'undoCourseOneScore',
                    title: '必修成绩分数/选修已得学分',
                    minWidth: 80
                }, {
                    fixed: 'right',
                    width: 150,
                    align: 'center',
                    toolbar: '#barDemo'
                } //这里的toolbar值是模板元素的选择器
                ]
            ],
            skin: 'line', //表格风格
            id: 'stuReload',
            even: true,
            page: true, //是否显示分页
            height: 'full-200', //高度最大化自适应
            limits: [5, 10, 15],
            limit: 5, //每页默认显示的数量
            done: function (res, curr, count) {
                alarmTableRowSpan("sid", 1);   // 在此处合并单元格
                alarmTableRowSpan("sname", 1);
            }
        });

        // var active = {
        //     reload: function() {
        //         var reload = $('#reload');
        //         //执行重载
        //         table.reload('stuReload', {
        //             url: 'getStuInfoBySid',
        //             method: 'get',
        //             page: {
        //                 curr: 1 //重新从第 1 页开始
        //             },
        //             where: { //类似于 data
        //                 sid: $('#reload').val() //传入搜索的学生id
        //             }
        //         });
        //     }
        // };


        var $ = layui.$,
            active = {
                reload: function () {
                    var demoReload = $('#demoReload');
                    //执行重载
                    table.reload('testReload', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        },
                        where: {
                            key: {
                                clsId: demoReload.val()
                            }
                        }
                    });
                }
            };

        $('#search').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    })

</script>


</body>

</html>