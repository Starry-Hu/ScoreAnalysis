<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/font.css">
    <link rel="stylesheet" href="lib/layui/css/layui.css">
    <title>专业学生总况</title>
    <style>
        .layui-form-label {
            width: 60px;
        }

        form {
            width: 600px;
        }
        table{
            border-collapse: initial;
        }
    </style>
</head>

<body class="layui-anim layui-anim-up">
<div>
    <div class="demoTable">
        <form id="editForm" class="layui-form">
            <div class="layui-form-item layui-inline">
                <label class="layui-form-label must">所选专业</label>
                <div class="layui-input-inline">
                    <select name="majorId" id="majorId">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item layui-inline">
                <div class="layui-btn" data-type="reload" id="search">搜索</div>
            </div>
        </form>
    </div>


    <table id="students" lay-filter="students"></table>
</div>

<script type="text/html" id="barDemo">
    {{#  if(d.undoCourseOneCname == "已修满"){ }}
    <a class="layui-btn layui-btn-sm layui-btn-disabled">已修满</a>
    {{# }else { }}
    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="inform">通知</a>
    {{#  } }}
</script>

<script type="text/javascript" src="js/jquery-3.3.1.js"></script>
<script src="lib/layui/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="js/layuiRowSpan.js"></script>

<script>
    layui.use(['table', 'form'], function () {
        var table = layui.table;
        var form = layui.form;

        jQuery(function () {
            // 加载可选专业
            jQuery.ajax({
                type: "get",
                url: "/ScoreAnalysis/major/getAllMajors", // 需要带上项目名(只有上传文件的时候不需要)
                dataType: "json",
                success: function (response) {
                    for (let i = 0; i < response.data.length; i++) {
                        const element = response.data[i];
                        var $option = `<option value='${element.mid}'> ${element.mname}</option>`;
                        $('#majorId').append($option);
                    }
                    form.render();
                }
            });
        })


        //展示已知数据
        table.render({
            elem: '#students',
            // toolbar: true,
            toolbar: 'default',
            url: 'student/getStuInfoByMajorWithPage', //数据接口(不需要带项目名)
            parseData: function (res) { //res 即为原始返回的数据
                var stuInfo = new Array();
                for (let i = 0; i < res.data.list.length; i++) {
                    // 获取必修课程数组
                    var undoCourseList = res.data.list[i].undoCourse;

                    // 如果没有未修课程，则显示已修满
                    if (undoCourseList.length == 0) {
                        // 根据长度自己拼接成json字符串
                        var jsonString = `{ "sid": "${res.data.list[i].sid}", "sname": "${res.data.list[i].sname}", "className": "${res.data.list[i].className}",
                        "majorName" : "${res.data.list[i].majorName}", "undoCourseOneCid": "已修满",
                        "undoCourseOneCname": "已修满", "undoCourseOneCredit": "已修满","undoCourseOneScore": "已修满" }`;
                        // 将上述字符串转成json
                        var obj = JSON.parse(jsonString);
                        // 添加到数组中
                        stuInfo.push(obj);
                    } else {
                        // 存在未修课程 则动态拼接
                        for (let j = 0; j < res.data.list[i].undoCourse.length; j++) {
                            // 根据长度自己拼接成json字符串
                            var jsonString = `{ "sid": "${res.data.list[i].sid}", "sname": "${res.data.list[i].sname}", "className": "${res.data.list[i].className}",
                        "majorName" : "${res.data.list[i].majorName}", "undoCourseOneCid": "${res.data.list[i].undoCourse[j].cid}",
                        "undoCourseOneCname": "${res.data.list[i].undoCourse[j].cname}", "undoCourseOneCredit": ${res.data.list[i].undoCourse[j].credit},
                        "undoCourseOneScore": ${res.data.list[i].undoCourse[j].score} }`;
                            // 将上述字符串转成json
                            var obj = JSON.parse(jsonString);
                            // 添加到数组中
                            stuInfo.push(obj);
                        }
                    }
                }
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data.totalRecord, //解析数据长度
                    // "data": res.data.list, //解析数据列表
                    "data": stuInfo, //解析数据列表
                };
            },
            response: {
                statusCode: 205 //规定成功的状态码，默认：0
            },
            request: {
                pageName: 'pageNum', //页码的参数名称，默认：page
                limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            cols: [
                [{
                    field: 'sid',
                    title: '学号',
                    width: 180
                },{
                    field: 'sname',
                    title: '姓名',
                    width: 180
                }, {
                    field: 'className',
                    title: '班级',
                    width: 180
                }, {
                    field: 'majorName',
                    title: '专业',
                    width: 180
                }, {
                    field: 'undoCourseOneCid',
                    title: '未修课程号',
                    minWidth: 80
                }, {
                    field: 'undoCourseOneCname',
                    title: '课程名称',
                    minWidth: 80
                }, {
                    field: 'undoCourseOneCredit',
                    title: '课程学分',
                    width: 100
                }, {
                    field: 'undoCourseOneScore',
                    title: '必修成绩分数/选修已得学分',
                    minWidth: 80
                }, {
                    fixed: 'right',
                    width: 150,
                    align: 'center',
                    toolbar: '#barDemo'
                } //这里的toolbar值是模板元素的选择器
                ]
            ],
            // even: true,
            page: true, //是否显示分页
            limits: [10,30,60,90,300],
            limit: 10, //每页默认显示的数量
            done: function (res, curr, count) {
                alarmTableRowSpan("sid", 1);   // 在此处合并单元格
                alarmTableRowSpan("sname", 1);
            },
            id: "dataTable"
        });

        // 数据重载（查询）
        var active = {
            reload: function () {
                //执行重载
                table.reload('dataTable', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    where: { //类似于 data
                        majorId: $('#majorId').val()
                    }
                });
            }
        };
        // 数据重载之后的刷新..?
        $('#search').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        // 工具条事件
        // table.on('tool(students)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
        //     var data = obj.data; //获得当前行数据
        //     var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
        //     var tr = obj.tr; //获得当前行 tr 的DOM对象
        //
        //     if(layEvent === 'detail'){ //查看
        //         //do somehing
        //     } else if(layEvent === 'del'){ //删除
        //         layer.confirm('真的删除行么', function(index){
        //             obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
        //             layer.close(index);
        //             //向服务端发送删除指令
        //         });
        //     } else if(layEvent === 'edit'){ //编辑
        //         //do something
        //
        //         //同步更新缓存对应的值
        //         obj.update({
        //             username: '123'
        //             ,title: 'xxx'
        //         });
        //     }
        // });
    })

</script>


</body>

</html>